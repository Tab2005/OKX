<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¼”åŠ©å¸‚å ´æƒæå™¨ (Web)</title>
    <!-- å¼•å…¥ Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç°¡å–®çš„æ·±è‰²ä¸»é¡Œ */
        body { background-color: #1a202c; color: #cbd5e0; }
        .control-panel { background-color: #2d3748; }
        .results-panel { background-color: #2d3748; }
        select, input { background-color: #4a5568; color: #e2e8f0; border-color: #718096; }
        button { background-color: #3182ce; color: white; }
        button:disabled { background-color: #a0aec0; cursor: not-allowed; }
        progress { accent-color: #3182ce; }
    </style>
</head>
<body class="font-sans p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">AI è¼”åŠ©å¸‚å ´æƒæå™¨</h1>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel p-6 rounded-lg shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- äº¤æ˜“æ‰€ & å¸‚å ´ -->
                <div>
                    <label for="exchange" class="block mb-2 text-sm font-medium">äº¤æ˜“æ‰€ (Exchange)</label>
                    <select id="exchange" class="w-full p-2.5 rounded-lg border">
                        <option value="okx">OKX</option>
                        <option value="binance">Binance (å¹£å®‰)</option>
                    </select>
                </div>
                <div>
                    <label for="market" class="block mb-2 text-sm font-medium">å¸‚å ´é¡å‹ (Market)</label>
                    <select id="market" class="w-full p-2.5 rounded-lg border">
                        <option value="spot">ç¾è²¨å¸‚å ´</option>
                        <option value="swap">æ°¸çºŒåˆç´„</option>
                    </select>
                </div>
                <div>
                    <label for="quote" class="block mb-2 text-sm font-medium">å ±åƒ¹è²¨å¹£ (Quote)</label>
                    <select id="quote" class="w-full p-2.5 rounded-lg border">
                        <option value="USDT">USDT</option>
                        <option value="USDC">USDC</option>
                    </select>
                </div>
                <!-- æ™‚æ¡† & å‹æ…‹ -->
                <div>
                    <label for="timeframe" class="block mb-2 text-sm font-medium">Kç·šæ™‚æ¡† (Timeframe)</label>
                    <select id="timeframe" class="w-full p-2.5 rounded-lg border">
                        <option value="5m">5åˆ†é˜</option>
                        <option value="15m">15åˆ†é˜</option>
                        <option value="30m">30åˆ†é˜</option>
                        <option value="1H">1å°æ™‚</option>
                        <option value="4H">4å°æ™‚</option>
                        <option value="1D">1å¤©</option>
                    </select>
                </div>
                <div>
                    <label for="pattern" class="block mb-2 text-sm font-medium">æŠ€è¡“å½¢æ…‹ (Pattern)</label>
                    <select id="pattern" class="w-full p-2.5 rounded-lg border">
                        <option value="long_patterns">å…¨éƒ¨åšå¤šå‹æ…‹</option>
                        <option value="triangle">ä¸‰è§’æ”¶æ–‚</option>
                        <option value="double_bottom">Wåº•å‹æ…‹</option>
                        <option value="ascending_triangle">ä¸Šå‡ä¸‰è§’å½¢</option>
                    </select>
                </div>
            </div>
            
            <!-- æƒææŒ‰éˆ• -->
            <div class="mt-8 text-center">
                <button id="scan-button" class="px-8 py-3 font-bold rounded-lg shadow-lg hover:bg-blue-600 transition duration-300">
                    é–‹å§‹æƒæ
                </button>
            </div>
        </div>

        <!-- çµæœé¢æ¿ -->
        <div class="results-panel p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4">æƒæé€²åº¦èˆ‡çµæœ</h2>
            <div id="status-text" class="text-gray-400 mb-4">è«‹è¨­å®šåƒæ•¸å¾Œï¼Œé»æ“Šé–‹å§‹æƒæ...</div>
            
            <!-- é€²åº¦æ¢ -->
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
            </div>

            <!-- çµæœåˆ—è¡¨ -->
            <div id="results-list" class="space-y-4">
                <!-- JavaScript å°‡æœƒåœ¨é€™è£¡å‹•æ…‹æ’å…¥çµæœ -->
            </div>
        </div>
    </div>

    <script>
        const scanButton = document.getElementById('scan-button');
        const statusText = document.getElementById('status-text');
        const progressBar = document.getElementById('progress-bar');
        const resultsList = document.getElementById('results-list');
        
        // vvv --- å”¯ä¸€çš„ä¿®æ”¹é»åœ¨é€™è£¡ --- vvv
        // è‡ªå‹•åµæ¸¬ç›®å‰çš„ç¶²å€ï¼Œç„¡è«–æ˜¯åœ¨æœ¬åœ°é‚„æ˜¯é›²ç«¯éƒ½èƒ½æ­£ç¢ºé‹ä½œ
        const apiUrl = window.location.origin; 
        // ^^^ -------------------------- ^^^

        let pollingInterval;

        scanButton.addEventListener('click', async () => {
            scanButton.disabled = true;
            scanButton.textContent = 'æƒæä¸­...';
            resultsList.innerHTML = '';
            progressBar.style.width = '0%';
            statusText.textContent = 'æ­£åœ¨æäº¤æƒæä»»å‹™...';

            const payload = {
                exchange: document.getElementById('exchange').value,
                market: document.getElementById('market').value,
                quote: document.getElementById('quote').value,
                timeframe: document.getElementById('timeframe').value,
                pattern: document.getElementById('pattern').value,
                limit: null
            };

            try {
                // ç™¼é€åˆ° /scan è·¯å¾‘ï¼Œç€è¦½å™¨æœƒè‡ªå‹•ä½¿ç”¨ç›®å‰çš„ç¶²åŸŸ
                const response = await fetch(`${apiUrl}/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);

                const data = await response.json();
                const taskId = data.task_id;
                statusText.textContent = `ä»»å‹™å·²æäº¤ (ID: ${taskId.substring(0, 8)}...)ï¼Œæ­£åœ¨ç­‰å¾…å¾Œç«¯è™•ç†...`;

                startPolling(taskId);

            } catch (error) {
                console.error('å•Ÿå‹•æƒæå¤±æ•—:', error);
                statusText.textContent = `éŒ¯èª¤ï¼šç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ä¼ºæœå™¨ã€‚è«‹æª¢æŸ¥æ—¥èªŒ(Logs)ã€‚`;
                scanButton.disabled = false;
                scanButton.textContent = 'é–‹å§‹æƒæ';
            }
        });

        function startPolling(taskId) {
            pollingInterval = setInterval(async () => {
                try {
                    // ç™¼é€åˆ° /status/[taskId] è·¯å¾‘
                    const response = await fetch(`${apiUrl}/status/${taskId}`);
                    if (!response.ok) throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
                    
                    const data = await response.json();

                    if (data.state === 'PROGRESS') {
                        const percentage = (data.current / data.total) * 100;
                        progressBar.style.width = `${percentage}%`;
                        statusText.textContent = `[${data.current}/${data.total}] ${data.status}`;
                    } else if (data.state === 'SUCCESS') {
                        stopPolling();
                        statusText.textContent = 'æƒæå®Œæˆï¼';
                        progressBar.style.width = '100%';
                        displayResults(data.result);
                    } else if (data.state === 'FAILURE') {
                        stopPolling();
                        statusText.textContent = `ä»»å‹™å¤±æ•—: ${data.status}`;
                    }
                } catch (error) {
                    console.error('è¼ªè©¢ç‹€æ…‹å¤±æ•—:', error);
                    statusText.textContent = `è¼ªè©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒ(Logs)ã€‚`;
                    stopPolling();
                }
            }, 2000);
        }

        function stopPolling() {
            clearInterval(pollingInterval);
            scanButton.disabled = false;
            scanButton.textContent = 'é–‹å§‹æƒæ';
        }

        function displayResults(results) {
            if (results.length === 0) {
                resultsList.innerHTML = '<p class="text-gray-400">æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç›®æ¨™ã€‚</p>';
                return;
            }
            resultsList.innerHTML = ''; // æ¸…ç©ºèˆŠçµæœ
            results.forEach(result => {
                let emoji = 'â³';
                if (result.status === 'breakout_up') emoji = 'ğŸ”¥';
                if (result.status === 'breakout_down') emoji = 'ğŸ’§';

                const resultElement = document.createElement('div');
                resultElement.className = 'p-4 rounded-lg bg-gray-800/50';
                resultElement.innerHTML = `
                    <p class="font-bold text-lg">${emoji} [${result.exchange.toUpperCase()}-${result.market.toUpperCase()}] ${result.pair}</p>
                    <p class="text-gray-300">${result.description}</p>
                `;
                resultsList.appendChild(resultElement);
            });
        }
    </script>

</body>
</html>